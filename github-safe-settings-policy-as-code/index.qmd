---
author: "[Patrick J. Roddy](https://paddyroddy.github.io)"
date: 2025-02-11
format: revealjs
subtitle: "[ARC Collaborations Hour](https://www.ucl.ac.uk/arc)"
title: "GitHub Safe-Settings: Policy as Code"
---

{{< include /_includes/qr-code.qmd >}}

##

[./safe-settings/deployment.yaml](https://github.com/UCL-MIRSG/.github/blob/main/safe-settings/deployment.yaml)

```{.yaml code-line-numbers="1|1-4|1-5|5-69"}
restrictedRepos:
  # these repos are all archived and will cause the GHA to fail
  # https://github.com/github/safe-settings/issues/443
  exclude:
    - ^AboutMeGateway$
    - ^admin$
    - ^ansible-collection-infrastructure-archive$
    - ^ansible-collection-omero$
    - ^ansible-collection-xnat$
    - ^ansible-collection-xnat-archive$
    - ^ansible-role-docker$
    - ^ansible-role-firewalld$
    - ^ansible-role-install-java$
    - ^ansible-role-install-python$
    - ^ansible-role-omero-web$
    - ^ansible-role-postgresql$
    - ^ansible-role-provision$
    - ^ansible-role-selinux-utils$
    - ^ansible-role-ssl-certificates$
    - ^ansible-role-template$
    - ^ansible-role-tomcat$
    - ^catch-srv-plugin$
    - ^chenies-mews-cleanup$
    - ^cmic-xnat-plugin$
    - ^comic100_dax_config$
    - ^despiad_customizations$
    - ^DevOps-Knowledge-Base$
    - ^DicomAnonUtils$
    - ^drc_cluster_dax_config$
    - ^exo-flim$
    - ^flimj-ops$
    - ^flimj-ops-scripts$
    - ^flimj-ui$
    - ^flimlib$
    - ^general_bulk_uploader$
    - ^gif_extras$
    - ^github-actions-maven$
    - ^Infrastructure$
    - ^LocalDevMedicalImagingEnv$
    - ^MIRSE-Research-and-Documentation$
    - ^mirsg-github-runner-docker$
    - ^mirsg-harvester-terraform-modules$
    - ^mirsg-xnat-user-documentation$
    - ^module_segmentation$
    - ^NCCID-clinical-datatype-for-Covid19-XNAT$
    - ^NCCID-clinical-datatype-release$
    - ^nccid-data-transfer$
    - ^NiftyPipe$
    - ^NiftyPipe-Data$
    - ^nimg1946-legacy-scripts$
    - ^nipype$
    - ^omero-ansible-sandpit$
    - ^OmeroInstaller$
    - ^OmeroInstallerConfig$
    - ^promis-omero-import$
    - ^protocols$
    - ^reimagine-bulk-uploader$
    - ^SUMMITCOVIDGateway$
    - ^test-gha-arc$
    - ^ucl-xsync$
    - ^uclh-gae-clinical-gateway$
    - ^xnat$
    - ^xnat-1946$
    - ^xnat-azure-template-terraform$
    - ^xnat-azure-terraform$
    - ^XNAT-FTD$
    - ^xnat-helper$
    - ^xnat-setup$
    - ^XnatInstaller$
```

##

[./safe-settings/organisation.yaml](https://github.com/UCL-MIRSG/.github/blob/main/safe-settings/organisation.yaml)

```{.yaml code-line-numbers="1-4|6-15|17-19"}
autolinks:
  - key_prefix: ARCMYS-
    url_template: https://myservices-arc.uk.4me.com/requests/<num>
    is_alphanumeric: false

repository:
  allow_auto_merge: true
  allow_merge_commit: false
  allow_rebase_merge: false
  delete_branch_on_merge: true
  has_discussions: false
  has_downloads: false
  has_wiki: false
  squash_merge_commit_message: PR_BODY
  squash_merge_commit_title: PR_TITLE

teams:
  - name: mirsg
    permission: admin
```

##

[./safe-settings/suborgs/rulesets.yaml](https://github.com/UCL-MIRSG/.github/blob/main/safe-settings/suborgs/rulesets.yaml)

```{.yaml code-line-numbers="1-2|4|4-17|19-43|45-64"}
suborgrepos:
  - "*"

rulesets:
  - name: Default
    target: branch
    enforcement: active

    conditions:
      ref_name:
        include:
          - ~DEFAULT_BRANCH
        exclude: []

    rules:
      - type: deletion
      - type: non_fast_forward # prevents force pushes

  - name: Pull Requests
    target: branch
    enforcement: active

    bypass_actors:
      - actor_id: 2740 # Renovate Bot
        actor_type: Integration
        bypass_mode: always

    conditions:
      ref_name:
        include:
          - ~DEFAULT_BRANCH
        exclude: []

    rules:
      - type: pull_request
        parameters:
          allowed_merge_types:
            - squash
          dismiss_stale_reviews_on_push: true
          require_code_owner_review: false
          require_last_push_approval: false
          required_approving_review_count: 1
          required_review_thread_resolution: false

  - name: Status Checks
    target: branch
    enforcement: active

    conditions:
      ref_name:
        include:
          - ~DEFAULT_BRANCH
        exclude: []

    rules:
      - type: required_status_checks
        parameters:
          do_not_enforce_on_create: false
          required_status_checks:
            - context: links
              integration_id: 15368
            - context: linting
              integration_id: 15368
          strict_required_status_checks_policy: false
```

##

[./.github/workflows/safe-settings.yaml](https://github.com/UCL-MIRSG/.github/blob/main/.github/workflows/safe-settings.yaml)

```{.yaml code-line-numbers="1|2|2-5|2,6-9|2,10-11|2,12|14-17|19-21|19,22-24|19,25|25-27|29-34|36-42|44-46|48-51|51-52,54-58,63,65|53,59-62,64"}
name: Safe Settings Sync
on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - safe-settings/**
      - .github/workflows/safe-settings.yaml
  schedule:
    - cron: 0 */4 * * *
  workflow_dispatch: {}

concurrency:
  cancel-in-progress: true
  group: >-
    ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

jobs:
  safe-settings-sync:
    runs-on: ubuntu-latest
    env:
      SAFE_SETTINGS_VERSION: 2.1.14
      SAFE_SETTINGS_CODE_DIR: .safe-settings-code
    steps:
      - name: Checkout source
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Checkout GitHub Safe-Settings repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          path: ${{ env.SAFE_SETTINGS_CODE_DIR }}
          ref: ${{ env.SAFE_SETTINGS_VERSION }}
          repository: github/safe-settings

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          cache-dependency-path:
            ${{ env.SAFE_SETTINGS_CODE_DIR }}/package-lock.json
          cache: npm
          node-version-file: ${{ env.SAFE_SETTINGS_CODE_DIR }}/.nvmrc

      - name: Install dependencies
        run: npm install
        working-directory: ${{ env.SAFE_SETTINGS_CODE_DIR }}

      - name: Run application
        run: npm run full-sync
        working-directory: ${{ env.SAFE_SETTINGS_CODE_DIR }}
        env:
          ADMIN_REPO: .github
          APP_ID: ${{ vars.SAFE_SETTINGS_APP_ID }}
          BLOCK_REPO_RENAME_BY_HUMAN: false
          CONFIG_PATH: safe-settings
          DEPLOYMENT_CONFIG_FILE:
            ${{ github.workspace }}/safe-settings/deployment.yaml
          ENABLE_PR_COMMENT: true
          GH_ORG: ${{ vars.SAFE_SETTINGS_GH_ORG }}
          GITHUB_CLIENT_ID: ${{ vars.SAFE_SETTINGS_GITHUB_CLIENT_ID }}
          GITHUB_CLIENT_SECRET:
            ${{ secrets.SAFE_SETTINGS_GITHUB_CLIENT_SECRET }}
          LOG_LEVEL: trace
          PRIVATE_KEY: ${{ secrets.SAFE_SETTINGS_PRIVATE_KEY }}
          SETTINGS_FILE_PATH: organisation.yaml
```
